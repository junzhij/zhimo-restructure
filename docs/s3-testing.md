# S3é›†æˆæµ‹è¯•æ–‡æ¡£

æœ¬æ–‡æ¡£æè¿°äº†æ™ºå¢¨å­¦ä¹ å¹³å°çš„S3é›†æˆæµ‹è¯•å¥—ä»¶ï¼ŒåŒ…æ‹¬æµ‹è¯•é…ç½®ã€è¿è¡Œæ–¹æ³•å’Œæµ‹è¯•è¦†ç›–èŒƒå›´ã€‚

## æµ‹è¯•å¥—ä»¶æ¦‚è§ˆ

### 1. S3è¿æ¥æµ‹è¯• (`npm run test:s3-connection`)
- **æ–‡ä»¶**: `scripts/test-s3-connection.js`
- **ç›®çš„**: éªŒè¯AWS S3é…ç½®æ˜¯å¦æ­£ç¡®
- **åŠŸèƒ½**:
  - æ£€æŸ¥ç¯å¢ƒå˜é‡é…ç½®
  - æµ‹è¯•S3è¿æ¥
  - éªŒè¯bucketè®¿é—®æƒé™
  - æµ‹è¯•åŸºæœ¬çš„ä¸Šä¼ /åˆ é™¤æ“ä½œ

### 2. çœŸå®S3é›†æˆæµ‹è¯• (`npm run test:s3-real`)
- **æ–‡ä»¶**: `tests/s3-real.test.js`
- **ç›®çš„**: æµ‹è¯•çœŸå®S3æ“ä½œåŠŸèƒ½
- **è¦†ç›–èŒƒå›´**:
  - åŸºæœ¬æ–‡ä»¶ä¸Šä¼ /ä¸‹è½½/åˆ é™¤
  - å¤§æ–‡ä»¶å¤šéƒ¨åˆ†ä¸Šä¼ 
  - PDFæ–‡ä»¶å¤„ç†
  - å¹¶å‘ä¸Šä¼ æµ‹è¯•
  - æ€§èƒ½æµ‹è¯•
  - é”™è¯¯å¤„ç†

### 3. åº”ç”¨å±‚S3é›†æˆæµ‹è¯• (`npm run test:s3`)
- **æ–‡ä»¶**: `tests/s3-integration.test.js`
- **ç›®çš„**: æµ‹è¯•åº”ç”¨å±‚çš„S3é›†æˆåŠŸèƒ½
- **è¦†ç›–èŒƒå›´**:
  - æ–‡æ¡£ä¸Šä¼ APIç«¯ç‚¹
  - æ–‡æ¡£ä¸‹è½½åŠŸèƒ½
  - æ–‡æ¡£åˆ é™¤åŠŸèƒ½
  - å¤šç§æ–‡ä»¶æ ¼å¼æ”¯æŒ
  - DocumentServiceç±»åŠŸèƒ½

## ç¯å¢ƒé…ç½®

### å¿…éœ€çš„ç¯å¢ƒå˜é‡

åœ¨è¿è¡ŒS3é›†æˆæµ‹è¯•ä¹‹å‰ï¼Œè¯·ç¡®ä¿åœ¨`.env`æ–‡ä»¶ä¸­é…ç½®ä»¥ä¸‹ç¯å¢ƒå˜é‡ï¼š

\`\`\`bash
# AWS S3é…ç½®
AWS_ACCESS_KEY_ID=your-access-key-id
AWS_SECRET_ACCESS_KEY=your-secret-access-key
AWS_REGION=your-aws-region
S3_BUCKET_NAME=your-bucket-name
\`\`\`

### æƒé™è¦æ±‚

æµ‹è¯•ç”¨çš„AWS IAMç”¨æˆ·éœ€è¦ä»¥ä¸‹S3æƒé™ï¼š

\`\`\`json
{
    "Version": "2012-10-17",
    "Statement": [
        {
            "Effect": "Allow",
            "Action": [
                "s3:GetObject",
                "s3:PutObject",
                "s3:DeleteObject",
                "s3:ListBucket"
            ],
            "Resource": [
                "arn:aws:s3:::your-bucket-name",
                "arn:aws:s3:::your-bucket-name/*"
            ]
        }
    ]
}
\`\`\`

## è¿è¡Œæµ‹è¯•

### 1. æ£€æŸ¥S3è¿æ¥
\`\`\`bash
npm run test:s3-connection
\`\`\`

### 2. è¿è¡ŒçœŸå®S3æµ‹è¯•
\`\`\`bash
npm run test:s3-real
\`\`\`

### 3. è¿è¡Œåº”ç”¨å±‚é›†æˆæµ‹è¯•
\`\`\`bash
npm run test:s3
\`\`\`

### 4. è¿è¡Œæ‰€æœ‰æµ‹è¯•
\`\`\`bash
npm test
\`\`\`

## æµ‹è¯•ç»“æœç¤ºä¾‹

### æˆåŠŸçš„S3è¿æ¥æµ‹è¯•
\`\`\`
=== S3è¿æ¥æµ‹è¯•å·¥å…· ===

ğŸ“‹ å½“å‰S3é…ç½®:
   AWS_REGION: ap-northeast-3
   S3_BUCKET_NAME: advx
   AWS_ACCESS_KEY_ID: å·²è®¾ç½®
   AWS_SECRET_ACCESS_KEY: å·²è®¾ç½®

ğŸ” æµ‹è¯•S3è¿æ¥...

ğŸ“¦ æµ‹è¯•Bucket: advx
ğŸŒ AWS Region: ap-northeast-3

1ï¸âƒ£ æµ‹è¯•åˆ—å‡ºå¯¹è±¡...
âœ… æˆåŠŸåˆ—å‡ºå¯¹è±¡ï¼Œæ‰¾åˆ° 0 ä¸ªå¯¹è±¡

2ï¸âƒ£ æµ‹è¯•ä¸Šä¼ æ–‡ä»¶...
âœ… æˆåŠŸä¸Šä¼ æµ‹è¯•æ–‡ä»¶: test/connection-test-1753437256136.txt

3ï¸âƒ£ æµ‹è¯•åˆ é™¤æ–‡ä»¶...
âœ… æˆåŠŸåˆ é™¤æµ‹è¯•æ–‡ä»¶: test/connection-test-1753437256136.txt

ğŸ‰ S3è¿æ¥æµ‹è¯•å…¨éƒ¨é€šè¿‡ï¼
\`\`\`

### çœŸå®S3é›†æˆæµ‹è¯•ç»“æœ
\`\`\`
Real S3 Integration Tests
  S3 Basic Operations
    âœ“ should upload file to S3 (713 ms)
    âœ“ should upload large file using multipart upload (3864 ms)
    âœ“ should download file from S3 (412 ms)
    âœ“ should handle PDF file upload (218 ms)
    âœ“ should delete file from S3 (418 ms)
    âœ“ should handle concurrent uploads (617 ms)
    âœ“ should measure upload performance (224 ms)
  S3 Error Handling
    âœ“ should handle non-existent bucket error (380 ms)
    âœ“ should handle invalid credentials (233 ms)

Test Suites: 1 passed, 1 total
Tests: 9 passed, 9 total
\`\`\`

## æµ‹è¯•è¦†ç›–çš„åŠŸèƒ½

### æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
- âœ… å°æ–‡ä»¶ä¸Šä¼  (< 5MB)
- âœ… å¤§æ–‡ä»¶å¤šéƒ¨åˆ†ä¸Šä¼  (> 5MB)
- âœ… PDFæ–‡ä»¶ä¸Šä¼ 
- âœ… å¤šç§æ–‡ä»¶æ ¼å¼æ”¯æŒ (PDF, DOCX, PPTX, å›¾ç‰‡)
- âœ… æ–‡ä»¶ç±»å‹éªŒè¯
- âœ… æ–‡ä»¶å¤§å°é™åˆ¶

### æ–‡ä»¶ä¸‹è½½åŠŸèƒ½
- âœ… æ–‡ä»¶æµä¸‹è½½
- âœ… æ­£ç¡®çš„Content-Typeè®¾ç½®
- âœ… æ–‡ä»¶åå¤„ç†

### æ–‡ä»¶åˆ é™¤åŠŸèƒ½
- âœ… S3æ–‡ä»¶åˆ é™¤
- âœ… æ•°æ®åº“è®°å½•è½¯åˆ é™¤
- âœ… æƒé™éªŒè¯

### æ€§èƒ½å’Œå¹¶å‘
- âœ… å¹¶å‘ä¸Šä¼ æµ‹è¯•
- âœ… ä¸Šä¼ æ€§èƒ½æµ‹è¯•
- âœ… å¤§æ–‡ä»¶å¤„ç†

### é”™è¯¯å¤„ç†
- âœ… æ— æ•ˆbucketå¤„ç†
- âœ… æ— æ•ˆå‡­è¯å¤„ç†
- âœ… ç½‘ç»œé”™è¯¯å¤„ç†
- âœ… æ–‡ä»¶éªŒè¯é”™è¯¯

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **ç¯å¢ƒå˜é‡æœªé…ç½®**
   - é”™è¯¯: "ç¼ºå°‘å¿…éœ€çš„ç¯å¢ƒå˜é‡"
   - è§£å†³: æ£€æŸ¥`.env`æ–‡ä»¶ä¸­çš„AWSé…ç½®

2. **æƒé™ä¸è¶³**
   - é”™è¯¯: "AccessDenied"
   - è§£å†³: æ£€æŸ¥IAMç”¨æˆ·æƒé™é…ç½®

3. **Bucketä¸å­˜åœ¨**
   - é”™è¯¯: "NoSuchBucket"
   - è§£å†³: ç¡®è®¤bucketåç§°æ­£ç¡®ä¸”å­˜åœ¨

4. **ç½‘ç»œè¿æ¥é—®é¢˜**
   - é”™è¯¯: "NetworkingError"
   - è§£å†³: æ£€æŸ¥ç½‘ç»œè¿æ¥å’ŒAWSæœåŠ¡çŠ¶æ€

### è°ƒè¯•æŠ€å·§

1. **å¯ç”¨è¯¦ç»†æ—¥å¿—**
   \`\`\`bash
   DEBUG=* npm run test:s3-real
   \`\`\`

2. **å•ç‹¬è¿è¡Œç‰¹å®šæµ‹è¯•**
   \`\`\`bash
   npx jest tests/s3-real.test.js -t "should upload file to S3"
   \`\`\`

3. **æ£€æŸ¥S3æ§åˆ¶å°**
   - ç™»å½•AWS S3æ§åˆ¶å°
   - æŸ¥çœ‹bucketä¸­çš„æµ‹è¯•æ–‡ä»¶
   - æ£€æŸ¥è®¿é—®æ—¥å¿—

## æœ€ä½³å®è·µ

### æµ‹è¯•ç¯å¢ƒéš”ç¦»
- ä½¿ç”¨ä¸“é—¨çš„æµ‹è¯•bucket
- æµ‹è¯•æ–‡ä»¶ä½¿ç”¨å”¯ä¸€å‰ç¼€ (`test/`)
- è‡ªåŠ¨æ¸…ç†æµ‹è¯•æ–‡ä»¶

### å®‰å…¨è€ƒè™‘
- ä¸è¦åœ¨ä»£ç ä¸­ç¡¬ç¼–ç AWSå‡­è¯
- ä½¿ç”¨æœ€å°æƒé™åŸåˆ™
- å®šæœŸè½®æ¢è®¿é—®å¯†é’¥

### æ€§èƒ½ä¼˜åŒ–
- å¯¹å¤§æ–‡ä»¶ä½¿ç”¨å¤šéƒ¨åˆ†ä¸Šä¼ 
- å®æ–½å¹¶å‘é™åˆ¶
- ç›‘æ§ä¸Šä¼ æ€§èƒ½

## æŒç»­é›†æˆ

åœ¨CI/CDæµæ°´çº¿ä¸­è¿è¡ŒS3æµ‹è¯•ï¼š

\`\`\`yaml
# GitHub Actionsç¤ºä¾‹
- name: Run S3 Integration Tests
  env:
    AWS_ACCESS_KEY_ID: \${{ secrets.AWS_ACCESS_KEY_ID }}
    AWS_SECRET_ACCESS_KEY: \${{ secrets.AWS_SECRET_ACCESS_KEY }}
    S3_BUCKET_NAME: \${{ secrets.S3_BUCKET_NAME }}
    AWS_REGION: ap-northeast-3
  run: |
    npm run test:s3-connection
    npm run test:s3-real
\`\`\`

## æ€»ç»“

S3é›†æˆæµ‹è¯•å¥—ä»¶æä¾›äº†å…¨é¢çš„æµ‹è¯•è¦†ç›–ï¼Œç¡®ä¿æ–‡æ¡£ä¸Šä¼ å’Œå­˜å‚¨åŠŸèƒ½çš„å¯é æ€§ã€‚é€šè¿‡åˆ†å±‚æµ‹è¯•ï¼ˆè¿æ¥æµ‹è¯•ã€çœŸå®S3æµ‹è¯•ã€åº”ç”¨å±‚æµ‹è¯•ï¼‰ï¼Œæˆ‘ä»¬å¯ä»¥å¿«é€Ÿå®šä½å’Œè§£å†³é—®é¢˜ï¼Œä¿è¯ç”Ÿäº§ç¯å¢ƒçš„ç¨³å®šæ€§ã€‚